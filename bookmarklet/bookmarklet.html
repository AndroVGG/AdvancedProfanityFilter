<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>APF Bookmarklet Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <h1>Generate Bookmarklet Code</h1>

  Custom Config (Export from extension):<br>
  <textarea id="config" style="width:500px;height:100px;"></textarea>
  <br>

  Code (Save to file):<br>
  <textarea id="code" style="width:500px;height:550px;"></textarea>
  <br>

  <br>
  <button id="customCode">Custom Code</button>

  <h1>Generate Bookmarklet</h1>

  Hosting URL:
  <br>
  <textarea id="fileURL" style="width:500px;height:24px;"></textarea>
  <br>

  <textarea id="bookmarkletText" style="width:500px;height:100px;"></textarea>
  <br>
  <button id="generateBookmarklet">Generate Bookmarklet</button>

  <script>
    function updateBookmarklet() {
      let prefix = "(function(){if(!document.querySelector('script.apfBookmarklet')){let apfScriptEl=document.body.appendChild(document.createElement('script'));apfScriptEl.src='"
      let postfix = "';apfScriptEl.className='apfBookmarklet';}})()";
      let fileURL = document.getElementById('fileURL').value;
      if (fileURL == '') {
        window.alert('Please enter a file URL');
      } else {
        document.getElementById('bookmarkletText').value = 'javascript:' + encodeURIComponent(prefix + fileURL + postfix);
      }
    }

    async function injectConfig() {
      const prefix = '/* << Start User Config >> */';
      const postfix = '/* << End User Config >> */';
      const configRegExp = /\/\* << Start User Config >> \*\/[\S\s]*\/\* << End User Config >> \*\//m;

      let origURL = '';
      let response = await fetch(origURL);
      let code = await response.text();
      try {
        let config = JSON.parse(document.getElementById('config').value);
        document.getElementById("code").innerHTML = code.replace(configRegExp, prefix + '\nvar config = ' + JSON.stringify(config) + ';\n' + postfix);
      } catch(e) {
        window.alert('Unable to read config - using defaults');
        document.getElementById("code").innerHTML = code;
      }
    }

    document.getElementById('generateBookmarklet').addEventListener('click', e => { updateBookmarklet(); });
    document.getElementById('customCode').addEventListener('click', e => { injectConfig(); });
  </script>
</body>
</html>
